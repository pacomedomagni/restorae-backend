// Prisma Schema for Restorae Backend
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum Role {
  USER
  ADMIN
  ANALYST
  SUPPORT
}

enum SubscriptionTier {
  FREE
  PREMIUM
  LIFETIME
}

enum ContentType {
  BREATHING
  GROUNDING
  RESET
  FOCUS
  SOS
  SITUATIONAL
  PROMPT
  MORNING_RITUAL
  EVENING_RITUAL
  AMBIENT_SOUND
  BEDTIME_STORY
}

enum ContentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum StoryCategory {
  NATURE
  TRAVEL
  FANTASY
  MEDITATION
  SOUNDSCAPES
  CLASSICS
}

enum StoryMood {
  CALM
  DREAMY
  COZY
  MAGICAL
}

enum AchievementCategory {
  CONSISTENCY
  SESSION
  MINDFULNESS
  EXPLORATION
  MASTERY
  SPECIAL
}

enum AchievementTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum MoodType {
  ENERGIZED
  CALM
  ANXIOUS
  LOW
  GOOD
  TOUGH
}

enum MoodContext {
  MORNING
  MIDDAY
  EVENING
  MANUAL
}

enum TimeOfDay {
  MORNING
  MIDDAY
  EVENING
  ANYTIME
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum LockMethod {
  BIOMETRIC
  PIN
  BOTH
  NONE
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

enum FeedbackType {
  GENERAL
  BUG
  FEATURE_REQUEST
  ABUSE_REPORT
}

enum FeedbackStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  CLOSED
}

// =============================================================================
// USER & AUTH
// =============================================================================

model User {
  id                  String    @id @default(cuid())
  email               String?   @unique
  emailVerified       Boolean   @default(false)
  passwordHash        String?
  name                String?
  avatarUrl           String?
  timezone            String    @default("UTC")
  locale              String    @default("en")
  role                Role      @default(USER)
  isActive            Boolean   @default(true)
  onboardingCompleted Boolean   @default(false)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  deletedAt           DateTime?
  
  // SSO
  appleId             String?   @unique
  googleId            String?   @unique
  
  // Password Reset
  passwordResetToken   String?
  passwordResetExpires DateTime?

  // Relations
  devices          Device[]
  sessions         Session[]
  preferences      Preference?
  subscription     Subscription?
  moodEntries      MoodEntry[]
  journalEntries   JournalEntry[]
  customRituals    CustomRitual[]
  ritualCompletions RitualCompletion[]
  reminders        Reminder[]
  weeklyGoals      WeeklyGoal[]
  feedbacks        Feedback[]
  activityLogs     ActivityLog[]
  userSessions     UserSession[]
  storyFavorites   UserStoryFavorite[]
  auditLogs        AuditLog[]        @relation("UserAuditLogs")
  adminAuditLogs   AuditLog[]        @relation("AdminAuditLogs")

  @@index([email])
  @@index([createdAt])
  @@index([appleId])
  @@index([googleId])
}

model Device {
  id              String   @id @default(cuid())
  userId          String
  deviceId        String   @unique
  platform        String   // ios, android
  osVersion       String?
  appVersion      String?
  pushToken       String?
  lastActiveAt    DateTime @default(now())
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([pushToken])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  refreshToken String   @unique
  deviceId     String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
}

// =============================================================================
// PREFERENCES
// =============================================================================

model Preference {
  id                  String     @id @default(cuid())
  userId              String     @unique
  theme               String     @default("system") // light, dark, system
  soundsEnabled       Boolean    @default(true)
  hapticsEnabled      Boolean    @default(true)
  lockMethod          LockMethod @default(NONE)
  lockOnBackground    Boolean    @default(true)
  lockTimeout         Int        @default(0) // seconds, 0 = immediate
  quietHoursEnabled   Boolean    @default(false)
  quietHoursStart     String?    // HH:mm
  quietHoursEnd       String?    // HH:mm
  updatedAt           DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// =============================================================================
// SUBSCRIPTIONS
// =============================================================================

model Subscription {
  id                String           @id @default(cuid())
  userId            String           @unique
  tier              SubscriptionTier @default(FREE)
  isTrialing        Boolean          @default(false)
  trialStartedAt    DateTime?
  trialEndsAt       DateTime?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelledAt       DateTime?
  revenuecatId      String?          @unique
  platform          String?          // ios, android, web
  productId         String?
  receiptData       Json?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  entitlements Entitlement[]

  @@index([revenuecatId])
}

model Entitlement {
  id             String   @id @default(cuid())
  subscriptionId String
  featureId      String
  grantedAt      DateTime @default(now())
  expiresAt      DateTime?
  source         String   // subscription, promo, admin

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, featureId])
  @@index([featureId])
}

// =============================================================================
// CONTENT LIBRARY
// =============================================================================

model ContentItem {
  id          String        @id @default(cuid())
  type        ContentType
  slug        String        @unique
  name        String
  description String
  data        Json          // Flexible schema per content type
  category    String?
  tags        String[]
  bestFor     String?
  duration    String?
  icon        String?
  imageUrl    String?       // For card backgrounds / thumbnails
  videoUrl    String?       // For immersive looping backgrounds
  isPremium   Boolean       @default(false)
  order       Int           @default(0)
  status      ContentStatus @default(DRAFT)
  version     Int           @default(1)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  publishedAt DateTime?

  locales     ContentLocale[]
  audioFile   AudioFile?      @relation(fields: [audioFileId], references: [id])
  audioFileId String?

  @@index([type, status, order]) // Composite index for common "Get All" queries
  @@index([isPremium, status])   // For filtering free/premium content
  @@index([type])
  @@index([status])
  @@index([isPremium])
  @@index([slug])
}

model ContentLocale {
  id            String   @id @default(cuid())
  contentItemId String
  locale        String   // en, es, fr, etc.
  name          String
  description   String
  data          Json?    // Localized dynamic fields
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contentItem ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@unique([contentItemId, locale])
}

model AudioFile {
  id          String   @id @default(cuid())
  name        String
  description String?
  url         String
  duration    Int?     // seconds
  fileSize    Int?     // bytes
  mimeType    String?
  uploadedBy  String?
  createdAt   DateTime @default(now())

  contentItems ContentItem[]
}

// =============================================================================
// MOOD TRACKING
// =============================================================================

model MoodEntry {
  id        String      @id @default(cuid())
  userId    String
  mood      MoodType
  note      String?
  context   MoodContext @default(MANUAL)
  factors   String[]    // Why user feels this way
  timestamp DateTime    @default(now())
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  deletedAt DateTime?

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  journalEntries JournalEntry[]

  @@index([userId])
  @@index([timestamp])
  @@index([mood])
  @@index([userId, timestamp])
}

model WeeklyGoal {
  id              String   @id @default(cuid())
  userId          String
  targetDays      Int      @default(7)
  completedDays   Int      @default(0)
  weekStart       DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStart])
  @@index([userId])
}

// =============================================================================
// JOURNALING
// =============================================================================

model JournalEntry {
  id           String    @id @default(cuid())
  userId       String
  title        String?
  content      String    // May be encrypted
  isEncrypted  Boolean   @default(false)
  isLocked     Boolean   @default(false) // Requires biometric
  promptId     String?
  moodEntryId  String?
  tags         String[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  moodEntry MoodEntry? @relation(fields: [moodEntryId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([userId, createdAt])
}

// =============================================================================
// RITUALS
// =============================================================================

model CustomRitual {
  id              String      @id @default(cuid())
  userId          String
  title           String
  description     String?
  timeOfDay       TimeOfDay   @default(ANYTIME)
  days            DayOfWeek[]
  reminderEnabled Boolean     @default(false)
  reminderTime    String?     // HH:mm
  isArchived      Boolean     @default(false)
  isFavorite      Boolean     @default(false)
  completedCount  Int         @default(0)
  lastCompletedAt DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  steps       RitualStep[]
  completions RitualCompletion[]

  @@index([userId])
  @@index([isArchived])
}

model RitualStep {
  id          String @id @default(cuid())
  ritualId    String
  title       String
  description String?
  duration    Int    // seconds
  order       Int

  ritual CustomRitual @relation(fields: [ritualId], references: [id], onDelete: Cascade)

  @@index([ritualId])
}

model RitualCompletion {
  id             String   @id @default(cuid())
  userId         String
  ritualId       String
  duration       Int      // actual seconds
  completedSteps Int
  totalSteps     Int
  mood           String?  // great, good, okay, tired
  notes          String?
  completedAt    DateTime @default(now())

  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  ritual CustomRitual @relation(fields: [ritualId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([ritualId])
  @@index([completedAt])
  @@index([userId, completedAt])
}

// =============================================================================
// NOTIFICATIONS & REMINDERS
// =============================================================================

model Reminder {
  id        String    @id @default(cuid())
  userId    String
  type      String    // morning, midday, evening, ritual, custom
  label     String
  time      String    // HH:mm
  enabled   Boolean   @default(true)
  ritualId  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model NotificationCampaign {
  id            String   @id @default(cuid())
  title         String
  body          String
  data          Json?
  segmentId     String?
  scheduledFor  DateTime?
  timezone      String?  // null = send in user's timezone
  sentCount     Int      @default(0)
  deliveredCount Int     @default(0)
  openedCount   Int      @default(0)
  createdBy     String
  createdAt     DateTime @default(now())
  sentAt        DateTime?

  segment Segment? @relation(fields: [segmentId], references: [id])
  logs    NotificationLog[]

  @@index([scheduledFor])
}

model NotificationLog {
  id          String             @id @default(cuid())
  campaignId  String?
  userId      String
  deviceId    String?
  title       String
  body        String
  status      NotificationStatus @default(PENDING)
  error       String?
  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  createdAt   DateTime           @default(now())

  campaign NotificationCampaign? @relation(fields: [campaignId], references: [id])

  @@index([userId])
  @@index([campaignId])
  @@index([status])
}

// =============================================================================
// SEGMENTATION
// =============================================================================

model Segment {
  id          String   @id @default(cuid())
  name        String
  description String?
  rules       Json     // Filter rules
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaigns NotificationCampaign[]
}

// =============================================================================
// SUPPORT & FEEDBACK
// =============================================================================

model Feedback {
  id           String         @id @default(cuid())
  userId       String?
  type         FeedbackType   @default(GENERAL)
  subject      String?
  message      String
  email        String?
  deviceInfo   Json?
  status       FeedbackStatus @default(NEW)
  assignedTo   String?
  internalNotes String?
  resolvedAt   DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([type])
  @@index([createdAt])
}

model FAQ {
  id        String   @id @default(cuid())
  question  String
  answer    String
  category  String?
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

// =============================================================================
// SYSTEM CONFIG
// =============================================================================

model FeatureFlag {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  enabled     Boolean  @default(false)
  rules       Json?    // Targeting rules
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedBy String?
  updatedAt DateTime @updatedAt
}

model LegalContent {
  id        String   @id @default(cuid())
  type      String   @unique // privacy_policy, terms_of_service
  title     String
  content   String   @db.Text
  version   Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =============================================================================
// AUDIT LOGS
// =============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?  // User affected
  adminId    String?  // Admin who performed action
  action     String
  resource   String
  resourceId String?
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user  User? @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: SetNull)
  admin User? @relation("AdminAuditLogs", fields: [adminId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([adminId])
  @@index([action])
  @@index([createdAt])
}

// =============================================================================
// USER SESSIONS (Activity Session Tracking)
// =============================================================================

enum SessionMode {
  SINGLE
  RITUAL
  SOS
}

enum SessionStatus {
  IN_PROGRESS
  COMPLETED
  EXITED
  INTERRUPTED
}

model UserSession {
  id              String        @id @default(cuid())
  userId          String
  mode            SessionMode
  status          SessionStatus @default(IN_PROGRESS)
  
  // References (optional based on mode)
  ritualId        String?       // For RITUAL mode - custom ritual reference
  ritualSlug      String?       // For RITUAL mode - preset ritual slug
  sosPresetId     String?       // For SOS mode
  
  // Stats
  totalActivities Int           @default(0)
  completedCount  Int           @default(0)
  skippedCount    Int           @default(0)
  totalDuration   Int           @default(0) // seconds
  
  // Timestamps
  startedAt       DateTime      @default(now())
  completedAt     DateTime?
  
  // Flags
  wasPartial      Boolean       @default(false) // User exited early
  wasInterrupted  Boolean       @default(false) // App crash/background
  
  // Metadata
  metadata        Json?         // Additional context
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  activities      SessionActivity[]
  
  @@index([userId])
  @@index([mode])
  @@index([status])
  @@index([startedAt])
  @@index([userId, startedAt])
}

model SessionActivity {
  id            String   @id @default(cuid())
  sessionId     String
  activityType  String   // breathing, grounding, focus, etc.
  activityId    String   // Reference to the activity
  activityName  String
  order         Int      // Position in the session queue
  
  // Completion
  completed     Boolean  @default(false)
  skipped       Boolean  @default(false)
  duration      Int?     // Actual duration in seconds
  
  // Timestamps
  startedAt     DateTime?
  completedAt   DateTime?
  
  session       UserSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([activityType])
}

// =============================================================================
// ACTIVITY LOGS
// =============================================================================

enum ActivityCategory {
  BREATHING
  GROUNDING
  RESET
  FOCUS
  JOURNAL
  MOOD
  STORY
  RITUAL
  SOS
}

model ActivityLog {
  id           String           @id @default(cuid())
  userId       String
  category     ActivityCategory
  activityType String           // The specific activity name (e.g., "4-7-8 Breathing")
  activityId   String?          // Reference to content if applicable
  duration     Int              // Duration in seconds
  completed    Boolean          @default(true)
  sessionId    String?          // Link to UserSession if part of a session
  metadata     Json?            // Additional data like cycles, mood, etc.
  timestamp    DateTime         @default(now()) // When the activity occurred
  createdAt    DateTime         @default(now()) // When the log was created

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category])
  @@index([timestamp])
  @@index([userId, category])
  @@index([userId, timestamp])
  @@index([sessionId])
}

// =============================================================================
// BEDTIME STORIES
// =============================================================================

model BedtimeStory {
  id              String        @id @default(cuid())
  slug            String        @unique
  title           String
  subtitle        String?
  description     String
  narrator        String
  duration        Int           // minutes
  audioUrl        String
  artworkUrl      String?
  category        StoryCategory
  tags            String[]
  isPremium       Boolean       @default(true)
  mood            StoryMood     @default(CALM)
  backgroundSound String?       // ID of ambient sound to layer
  order           Int           @default(0)
  status          ContentStatus @default(DRAFT)
  listenCount     Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  publishedAt     DateTime?

  locales    BedtimeStoryLocale[]
  favoritedBy UserStoryFavorite[]

  @@index([category, status, order])
  @@index([isPremium, status])
  @@index([mood])
  @@index([slug])
}

model BedtimeStoryLocale {
  id          String   @id @default(cuid())
  storyId     String
  locale      String   // en, es, fr, etc.
  title       String
  subtitle    String?
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  story BedtimeStory @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, locale])
}

// =============================================================================
// ACHIEVEMENTS & GAMIFICATION
// =============================================================================

model Achievement {
  id          String              @id @default(cuid())
  key         String              @unique
  title       String
  description String
  icon        String
  category    AchievementCategory
  tier        AchievementTier     @default(BRONZE)
  requirement Int                 // Number needed to unlock
  xpReward    Int                 @default(0)
  isSecret    Boolean             @default(false)
  order       Int                 @default(0)
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  userAchievements UserAchievement[]
  locales          AchievementLocale[]

  @@index([category])
  @@index([tier])
  @@index([isActive])
  @@index([key])
}

model AchievementLocale {
  id            String   @id @default(cuid())
  achievementId String
  locale        String
  title         String
  description   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([achievementId, locale])
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  achievementId String
  progress      Int      @default(0) // Current progress towards requirement
  unlockedAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([unlockedAt])
}

model UserLevel {
  id             String   @id @default(cuid())
  userId         String   @unique
  level          Int      @default(1)
  currentXp      Int      @default(0)
  totalXp        Int      @default(0)
  currentStreak  Int      @default(0)
  longestStreak  Int      @default(0)
  lastActiveDate DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([level])
  @@index([currentStreak])
}

// =============================================================================
// COACH MARKS / ONBOARDING HINTS
// =============================================================================

model CoachMark {
  id          String        @id @default(cuid())
  key         String        @unique
  screen      String        // Which screen this appears on
  title       String
  description String
  position    String        @default("center") // top, bottom, center
  order       Int           @default(0)
  isActive    Boolean       @default(true)
  status      ContentStatus @default(PUBLISHED)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  locales CoachMarkLocale[]

  @@index([screen, isActive])
  @@index([key])
}

model CoachMarkLocale {
  id          String   @id @default(cuid())
  coachMarkId String
  locale      String
  title       String
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  coachMark CoachMark @relation(fields: [coachMarkId], references: [id], onDelete: Cascade)

  @@unique([coachMarkId, locale])
}

// =============================================================================
// USER STORY FAVORITES
// =============================================================================

model UserStoryFavorite {
  id        String   @id @default(cuid())
  userId    String
  storyId   String
  createdAt DateTime @default(now())

  user  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  story BedtimeStory  @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([userId, storyId])
  @@index([userId])
  @@index([storyId])
}
